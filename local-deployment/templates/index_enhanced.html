<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True-Asset-ALLUSE Enhanced Local</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; }
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .metric-value { color: #f9fafb; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .chat-bubble-user { background-color: #3b82f6; color: white; }
        .chat-bubble-ai { background-color: #4b5563; color: white; }
    </style>
</head>
<body>
    <div id="app" class="p-4 md:p-8">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">True-Asset-ALLUSE</h1>
            <div class="flex items-center space-x-4">
                <span class="text-sm">Last Update: {{ lastUpdate }}</span>
                <div :class="['w-4 h-4 rounded-full', systemStatusClass]"></div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Portfolio Summary -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Portfolio Summary</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Total Value</p>
                            <p class="text-2xl font-bold metric-value">${{ formatCurrency(portfolio.total_value) }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Daily P&L</p>
                            <p :class="['text-2xl font-bold', pnlClass]">${{ formatCurrency(portfolio.daily_pnl) }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Daily Return</p>
                            <p :class="['text-2xl font-bold', pnlClass]">{{ portfolio.daily_pnl_percent?.toFixed(2) }}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Portfolio Delta</p>
                            <p class="text-2xl font-bold metric-value">{{ portfolio.portfolio_delta?.toFixed(3) }}</p>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Chart -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Portfolio Performance</h2>
                    <canvas id="portfolioChart"></canvas>
                </div>

                <!-- Positions Table -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Active Positions ({{ portfolio.active_positions }})</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-400 uppercase">
                                <tr>
                                    <th class="px-4 py-2">Symbol</th>
                                    <th class="px-4 py-2">Type</th>
                                    <th class="px-4 py-2">Position</th>
                                    <th class="px-4 py-2">Market Value</th>
                                    <th class="px-4 py-2">Unrealized P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="pos in portfolio.positions" :key="pos.symbol" class="border-b border-gray-700">
                                    <td class="px-4 py-2">{{ pos.symbol }}</td>
                                    <td class="px-4 py-2">{{ pos.sec_type }}</td>
                                    <td class="px-4 py-2">{{ pos.position }}</td>
                                    <td class="px-4 py-2">${{ formatCurrency(pos.market_value) }}</td>
                                    <td :class="['px-4 py-2', pos.unrealized_pnl >= 0 ? 'positive' : 'negative']">${{ formatCurrency(pos.unrealized_pnl) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- AI Assistant -->
                <div class="card p-6 rounded-lg h-full flex flex-col">
                    <h2 class="text-xl font-semibold mb-4">AI Assistant</h2>
                    <div class="flex-grow overflow-y-auto mb-4 h-96">
                        <div v-for="msg in chatHistory" class="mb-4">
                            <div v-if="msg.role === 'user'" class="flex justify-end">
                                <div class="chat-bubble-user p-3 rounded-lg max-w-xs">{{ msg.content }}</div>
                            </div>
                            <div v-else class="flex justify-start">
                                <div class="chat-bubble-ai p-3 rounded-lg max-w-xs">{{ msg.content }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex">
                        <input v-model="chatInput" @keyup.enter="sendChatMessage" type="text" class="w-full bg-gray-800 border border-gray-600 rounded-l-lg p-2 focus:outline-none" placeholder="Ask about your portfolio...">
                        <button @click="sendChatMessage" class="bg-blue-600 text-white px-4 rounded-r-lg">Send</button>
                    </div>
                </div>

                <!-- Market Sentiment -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Market Sentiment</h2>
                    <div class="text-center">
                        <p class="text-lg font-bold" :class="sentimentClass">{{ news.overall_sentiment }}</p>
                        <p class="text-sm text-gray-400">Based on {{ news.article_count }} articles</p>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                            <div class="bg-green-500 h-2.5 rounded-l-full" :style="{ width: news.positive_percentage + '%' }"></div>
                            <div class="bg-red-500 h-2.5 rounded-r-full" :style="{ width: news.negative_percentage + '%' }"></div>
                        </div>
                    </div>
                </div>

                <!-- System Health -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">System Health</h2>
                    <div class="space-y-2 text-sm">
                        <div v-for="(service, name) in serviceHealth" class="flex justify-between items-center">
                            <span>{{ name.toUpperCase() }}</span>
                            <span :class="['font-bold', service.status === 'healthy' ? 'text-green-400' : 'text-red-400']">{{ service.status }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue

        createApp({
            setup() {
                const portfolio = ref({})
                const news = ref({})
                const serviceHealth = ref({})
                const lastUpdate = ref('')
                const chatHistory = ref([])
                const chatInput = ref('')
                let portfolioChart = null

                const fetchData = async () => {
                    try {
                        const [p, n, s] = await Promise.all([
                            axios.get('/api/v1/portfolio'),
                            axios.get('/api/v1/news-sentiment'),
                            axios.get('/api/v1/system-status')
                        ])
                        portfolio.value = p.data
                        news.value = n.data
                        serviceHealth.value = s.data.service_health
                        lastUpdate.value = new Date(s.data.last_updates.portfolio).toLocaleTimeString()
                        updateChart()
                    } catch (error) {
                        console.error("Failed to fetch data:", error)
                    }
                }

                const sendChatMessage = async () => {
                    if (!chatInput.value.trim()) return
                    const userMessage = chatInput.value
                    chatHistory.value.push({ role: 'user', content: userMessage })
                    chatInput.value = ''

                    try {
                        const response = await axios.post('/api/v1/chat', { message: userMessage })
                        chatHistory.value.push({ role: 'ai', content: response.data.response })
                    } catch (error) {
                        console.error("Chat error:", error)
                        chatHistory.value.push({ role: 'ai', content: 'Sorry, I am having trouble connecting.' })
                    }
                }

                const updateChart = () => {
                    if (!portfolioChart) {
                        const ctx = document.getElementById('portfolioChart').getContext('2d')
                        portfolioChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: Array(30).fill('').map((_, i) => `Day ${i+1}`),
                                datasets: [{
                                    label: 'Portfolio Value',
                                    data: [],
                                    borderColor: '#3b82f6',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: { beginAtZero: false }
                                }
                            }
                        })
                    }
                    const chartData = portfolioChart.data.datasets[0].data
                    chartData.push(portfolio.value.total_value)
                    if (chartData.length > 30) chartData.shift()
                    portfolioChart.update()
                }

                onMounted(() => {
                    fetchData()
                    setInterval(fetchData, 5000)
                })

                const formatCurrency = (value) => {
                    if (typeof value !== 'number') return '0.00'
                    return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                }

                const pnlClass = computed(() => portfolio.value.daily_pnl >= 0 ? 'positive' : 'negative')
                const sentimentClass = computed(() => {
                    if (news.value.overall_sentiment === 'positive') return 'positive'
                    if (news.value.overall_sentiment === 'negative') return 'negative'
                    return 'text-gray-400'
                })
                const systemStatusClass = computed(() => {
                    const allHealthy = Object.values(serviceHealth.value).every(s => s.status === 'healthy')
                    return allHealthy ? 'bg-green-500' : 'bg-red-500'
                })

                return {
                    portfolio,
                    news,
                    serviceHealth,
                    lastUpdate,
                    chatHistory,
                    chatInput,
                    sendChatMessage,
                    formatCurrency,
                    pnlClass,
                    sentimentClass,
                    systemStatusClass
                }
            }
        }).mount('#app')
    </script>
</body>
</html>

